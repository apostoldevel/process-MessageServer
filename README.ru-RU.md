[![en](https://img.shields.io/badge/lang-en-green.svg)](README.md)

Сервер сообщений
-
**MessageServer** — процесс для [Апостол](https://github.com/apostoldevel/apostol).

Описание
-
**MessageServer** — долгоживущий фоновый процесс, который доставляет исходящие сообщения из таблицы исходящих сообщений PostgreSQL во внешние сервисы. Авторизуется как `apibot`, опрашивает очередь сообщений и отправляет каждое сообщение через соответствующий коннектор, выбираемый по типу агента.

Процесс работает независимо внутри мастер-процесса Апостол, используя общий цикл событий на основе `epoll` — без потоков, без блокирующего ввода-вывода.

Принцип работы
-
1. Авторизуется через OAuth2 `client_credentials` как `apibot`; повторная авторизация каждые 24 часа.
2. Подписывается на PostgreSQL-канал уведомлений `outbox` через `LISTEN outbox`.
3. Каждую минуту опрашивает `api.outbox('prepared')` для получения сообщений из очереди.
4. Для каждого сообщения получает полные данные через `api.get_service_message(id)` и отправляет через соответствующий коннектор.
5. При успехе — вызывает `api.execute_object_action(id, 'done')`.
6. При ошибке — записывает текст ошибки и вызывает `api.execute_object_action(id, 'fail')`.

Агенты сообщений
-
Выбор коннектора определяется двумя полями в записи сообщения: `agenttypecode` и `agentcode`.

| Тип агента | Код агента | Коннектор | Транспорт |
|------------|-----------|-----------|-----------|
| `email.agent` | `smtp.agent` | `CSMTPConnector` | Электронная почта по SMTP |
| `api.agent` | `fcm.agent` | `CFCMConnector` | Push-уведомления через Firebase Cloud Messaging |
| `api.agent` | `m2m.agent` | `CM2MConnector` | SMS через МТС Коммуникатор (M2M API) |
| `api.agent` | `sba.agent` | `CSBAConnector` | Интернет-эквайринг Сбербанка |
| `api.agent` | _(другой)_ | `CAPIConnector` | Универсальный HTTP API-вызов |

Ответы от HTTP API-коннекторов сохраняются во входящих через `api.add_inbox`.

Токены провайдеров (OAuth2 / сервисные аккаунты Google) загружаются при запуске и обновляются каждые 55 минут.

Настройка
-
Включите процесс и укажите конфигурационные файлы коннекторов в конфигурации Апостол:

```ini
[process/MessageServer]
enable=true
smtp=conf/smtp.conf      # SMTP-сервер(ы)
fcm=conf/fcm.conf        # Учётные данные Firebase Cloud Messaging
m2m=conf/m2m.conf        # Учётные данные МТС Коммуникатор (M2M)
sba=conf/sba.conf        # Учётные данные Сбербанк-эквайринг
api=conf/api.conf        # Настройки универсального API-коннектора
```

Каждый ключ в секции `[process/MessageServer]` (кроме `enable`) воспринимается как имя профиля, указывающего на файл конфигурации коннектора. Профили, содержащие поле `oauth2`, инициируют автоматическую загрузку OAuth2-провайдеров.

Модуль базы данных
-
MessageServer тесно связан с модулем **`message`** платформы [db-platform](https://github.com/apostoldevel/db-platform) (`db/sql/platform/entity/object/document/message/`).

Ключевые объекты базы данных:

| Объект | Назначение |
|--------|-----------|
| `db.message` | Запись сообщения: агент, профиль (домен/провайдер отправителя), адрес (получатель), тема, содержимое |
| Субсущность `outbox` | Очередь исходящих сообщений с конечным автоматом; отправляет `NOTIFY 'outbox'` при переходе сообщения в состояние prepared |
| `api.outbox(state)` | Возвращает сообщения в заданном состоянии (обычно `'prepared'`) |
| `api.get_service_message(id)` | Получает полные данные сообщения для отправки |
| `api.execute_object_action(id, action)` | Переходы состояний: `'send'`, `'done'`, `'fail'`, `'cancel'` |
| `api.add_inbox(...)` | Сохраняет ответ HTTP API как входящую запись |

Связанные модули
-
- **PGFetch** — HTTP-клиент, используемый API-коннекторами (FCM, M2M, SBA, универсальный API)

Установка
-
Следуйте указаниям по сборке и установке [Апостол](https://github.com/apostoldevel/apostol#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0).
